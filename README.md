# 数学题目作答检测工具

这是一个基于OpenCV和Qwen大模型的数学题目作答检测工具，可以自动识别画面中的数学题目，检测题目下方的作答区域，并判断作答情况（空白/正确/错误），同时提供错误原因分析。

## 功能特性

- 📹 实时视频捕获（720P分辨率）
- 🔍 自动识别数学题目和作答区域
- ✍️ 智能检测作答情况（空白/正确/错误）
- 💡 错误原因分析
- 🎯 实时显示作答状态和反馈

## 环境要求

- Python 3.7+
- 摄像头设备
- Qwen API Key（阿里云DashScope）

## 安装步骤

1. 安装依赖包：

```bash
pip install -r requirements.txt
```

2. 设置API Key：

**方法一：使用 .env 文件（推荐）**

创建 `.env` 文件（项目根目录），添加以下内容：

```bash
DASHSCOPE_API_KEY=your-api-key-here
```

**方法二：使用环境变量**

在终端中设置环境变量：

```bash
# macOS/Linux
export DASHSCOPE_API_KEY=your-api-key-here

# Windows (PowerShell)
$env:DASHSCOPE_API_KEY="your-api-key-here"
```

获取API Key：https://www.alibabacloud.com/help/zh/model-studio/get-api-key

> ⚠️ **安全提示**：`.env` 文件已添加到 `.gitignore`，不会被提交到 Git 仓库。请勿在代码中硬编码 API Key！

3. 验证配置（可选）：

运行测试脚本检查 API Key 是否正确配置：

```bash
python test_env.py
```

如果配置正确，会显示 API Key 的部分信息（已脱敏）；如果未配置，会显示详细的设置说明。

## 使用方法

1. 运行程序：

```bash
python main.py
```

2. 将数学题目放在摄像头前，程序会自动：
   - 识别画面中的第一个数学题目
   - 定位题目下方的作答空白区域
   - 检测作答情况（空白/正确/错误）
   - 如果错误，分析错误原因
   - 在作答区域左上角显示状态和反馈

3. 操作说明：
   - 按 `q` 键退出程序
   - 按 `f` 键切换全屏/窗口模式
   - 状态显示区域在左侧10%区域

## 显示说明

- **空白**：显示"请开始作答"（灰色文字）
- **正确**：显示"正确"（绿色文字）
- **错误**：显示"错误：错误原因"（红色文字，包含具体错误原因）

## 技术实现

- **视频捕获**: OpenCV (`cv2.VideoCapture`)，720P分辨率
- **多线程处理**: Python `threading` 模块，实现视频捕获和AI检测的并发
- **API调用**: OpenAI兼容接口调用Qwen3-VL-Plus模型
  - 图像理解：识别数学题目
  - OCR功能：提取题目和作答内容
  - 答案判断：判断作答是否正确
  - 错误分析：分析错误原因
- **图像处理**: OpenCV进行图像处理和文字绘制
- **坐标解析**: JSON解析API返回的作答区域坐标信息
- **UI渲染**: PIL/Pillow绘制中文文字

## 工作流程

1. **视频捕获**: 持续从摄像头捕获视频帧（720P）
2. **题目检测**: 每3秒调用一次Qwen API，识别画面中的第一个数学题目
3. **作答区域定位**: API定位题目下方的空白作答区域
4. **作答检测**: 检测作答区域是否有内容
5. **答案判断**: 如果有作答，判断答案是否正确
6. **错误分析**: 如果错误，分析错误原因
7. **状态显示**: 在作答区域左上角显示状态和反馈（白色文字）

## 项目结构

```
.
├── main.py              # 主程序文件（视频捕获、题目检测、状态显示）
├── qwen_client.py      # Qwen API客户端（题目识别、作答检测、答案判断）
├── test_env.py         # 环境变量配置测试脚本
├── requirements.txt     # 依赖包列表
├── .gitignore          # Git忽略文件（包含 .env）
├── .env                 # 环境变量文件（需自行创建，不提交到Git）
└── README.md           # 说明文档
```

## 注意事项

- 确保摄像头已连接且未被其他程序占用
- 如果默认摄像头索引不是0，可以修改 `main.py` 中的 `camera_index` 参数
- API调用需要网络连接
- 检测频率为每3秒一次，以减少API调用成本
- 每次API调用都是独立的，不保留历史上下文
- 识别和判断质量取决于：
  - 画面清晰度
  - 题目和作答的可见程度
  - 光照条件

## 配置参数

在 `qwen_client.py` 中可以调整以下参数：

- `IMAGE_QUALITY`: JPEG压缩质量 (1-100)，默认75
- `IMAGE_MAX_SIZE`: 最大图像尺寸（像素），默认1280（720P）

在 `main.py` 中可以调整以下参数：

- `api_call_interval`: API调用间隔（秒），默认3.0秒
- `camera_index`: 摄像头索引，默认0
